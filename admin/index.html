<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Cabañas La Delfina</title>
    <link rel="stylesheet" href="/admin/styles-admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="login-container">
        <div class="login-background" style="background-image: url('../images/galeria-1.png');"></div>
        <div class="login-overlay"></div>
        <div class="login-content">
            <div class="login-box">
                <h1 class="login-title">Cabañas La Delfina</h1>
                <h2 class="login-subtitle">Panel de Administración</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="border-right: 1px solid #e0e0e0; padding-right: 20px;">
                        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 15px; color: #333;">Login tradicional</h3>
                        <form id="loginForm">
                            <div class="form-group">
                                <label for="username">Usuario</label>
                                <input type="text" id="username" name="username" required autocomplete="username">
                            </div>
                            <div class="form-group">
                                <label for="password">Contraseña</label>
                                <input type="password" id="password" name="password" required autocomplete="current-password">
                            </div>
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="rememberMe" style="margin-right: 8px; width: auto;">
                                    <span>Guardar contraseña</span>
                                </label>
                            </div>
                            <button type="submit" class="btn-login">Ingresar</button>
                            <div id="loginError" class="error-message"></div>
                        </form>
                    </div>
                    <div style="padding-left: 20px;">
                        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 15px; color: #333;">Login con Accounts</h3>
                        <div id="accounts-login-beta-01"></div>
                    </div>
                </div>
                <style>
                    @media (max-width: 768px) {
                        .login-box > div[style*="grid-template-columns"] {
                            grid-template-columns: 1fr !important;
                        }
                        .login-box > div[style*="grid-template-columns"] > div[style*="border-right"] {
                            border-right: none !important;
                            border-bottom: 1px solid #e0e0e0;
                            padding-right: 0 !important;
                            padding-bottom: 20px;
                            margin-bottom: 20px;
                        }
                        .login-box > div[style*="grid-template-columns"] > div[style*="padding-left"] {
                            padding-left: 0 !important;
                        }
                    }
                </style>
            </div>
            <div class="login-footer">
                <p>Desarrollado por <strong>Punto Indigo</strong></p>
            </div>
        </div>
    </div>
    <script src="/admin/login.js"></script>
    <script
      src="https://accounts.puntoindigo.com/embed/accounts-login.beta.01.js"
      data-accounts-base="https://accounts.puntoindigo.com"
      data-target="accounts-login-beta-01"
      data-accounts-embed
    ></script>
    <script>
      window.AccountsLoginBeta01 = {
        onSuccess: async (data) => {
          try {
            const response = await fetch('/api/auth/accounts', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token: data.token })
            });
            
            const result = await response.json();
            
            // Verificar respuesta HTTP y contenido
            if (!response.ok) {
              // Si es 403, el usuario no tiene acceso
              if (response.status === 403) {
                throw new Error('Tu cuenta no tiene acceso a esta aplicación. Contactá al administrador.');
              }
              // Si es 401, token inválido
              if (response.status === 401) {
                throw new Error('Token inválido o expirado. Por favor, intentá nuevamente.');
              }
              throw new Error(result.error || 'Error validando token');
            }
            
            // Verificar que result.authenticated sea true
            if (!result.authenticated) {
              throw new Error('Acceso denegado. Tu cuenta no tiene permisos para esta aplicación.');
            }
            
            // Guardar sesión
            sessionStorage.setItem('adminLoggedIn', 'true');
            sessionStorage.setItem('adminUser', result.user.email);
            
            // Redirigir
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
            if (isMobile) {
              window.location.href = '/admin/galeria-mobile';
            } else {
              window.location.href = '/admin/galeria';
            }
          } catch (error) {
            console.error('Error:', error);
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
              errorDiv.textContent = error.message || 'Error al autenticar con Accounts. Por favor, intentá nuevamente.';
              errorDiv.classList.add('show');
            }
            // IMPORTANTE: No redirigir si hay error
            // El usuario debe quedarse en la página de login
          }
        },
        onError: (error) => {
          console.error('Error de autenticación:', error.reason);
          const errorDiv = document.getElementById('loginError');
          if (errorDiv) {
            errorDiv.textContent = 'Error de autenticación: ' + (error.reason || 'Error desconocido');
            errorDiv.classList.add('show');
          }
        }
      };
    </script>
</body>
</html>

